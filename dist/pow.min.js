export default(()=>{const t=/\{\{\s*(!*\*?[\$\w]+(\.\*?[\$\w]+)*.*?)\s*\}\}/g;function e(t,e=["item","array","if","ifnot"]){var n={};return e.find((e=>{const r=t.getAttribute(e);if(null!=r)return t.removeAttribute(e),n={attr:e,token:r}})),n}function n(e,n,o){for(;o=t.exec(e);){const a=r(o[1],n);t.lastIndex=o.index+`${a}`.length,e=e.substring(0,o.index)+(a??"")+e.slice(o.index+o[0].length)}return e}function r(t,e){try{t="*"==t[0]?"$"+t.slice(1):t;const n=Object.entries(!Array.isArray(e.$data)&"string"!=typeof e.$data?{...e.$data,...e}:{...e}),r=new Function(...n.map((t=>t[0])),`return ${t}`)(...n.map((t=>t[1])));if("function"==typeof r){const t=`_${Math.random().toString(36).slice(2)}`;return window.$pow$[t]=t=>r.call(t,e.$data,e.$root),`$pow$.${t}(this)`}return r}catch(n){console.warn("Interpolation failed",{"*path":e.$path,token:t},n)}}function o(t,n){if(t?.attributes.pow){const{attr:r,token:o}=e(t,["else-if","else-ifnot","else"]);if(r&n)return t.remove(),!0;r&"else"!=r&&t.setAttribute(r.slice(5),o)}}function a(t,i){const{attr:s,token:$}=e(t),f=$&&i?r($,i):void 0;if("if"==s|"ifnot"==s){const e="if"!=s?f:!f;for(;o(t.nextElementSibling,!e););if(e)return void t.remove()}else if("item"==s)$&void 0===(i={$path:`${i.$path}.${$||t.id||""}`,$data:$?f:i.$data,$parent:$?i.$data:i.$parent,$root:i.$root}).$data&&console.warn("Template binding without data",i.$path);else if("array"==s&"object"==typeof i.$data){const e=Array.isArray(f)?f:Object.entries(f).map((([t,e])=>({$key:t,$value:e})));for(var c=0;c<e.length;++c){const n=t.cloneNode(1);t.parentNode.insertBefore(n,t),a(n,{$path:`${i.$path}${$?"."+$:""}[${c}]`,$index:c,first:!c,$last:c>e.length-2,$data:e[c],$parent:i,$root:i.$root})}return void t.remove()}const l=function(t){return t.removeAttribute("pow"),[...(t.content??t).querySelectorAll("*[pow]:not([pow] [pow])")]}(t);for(const t of l)a(t,i);for(const{name:e,value:r}of t.attributes)t.setAttribute(e,n(r,i));const p=n(t.innerHTML,i);t instanceof HTMLTemplateElement?(t.insertAdjacentHTML("afterend",p),t.remove()):t.innerHTML=p}function i(t){const e=t.innerHTML,n=[...t.attributes||[]].map((({name:t,value:e})=>[t,e])),r={apply:o=>{if(t.$pow)return console.warn("Binding already in progress");t.$pow=1,window.$pow$={},t.innerHTML=e;for(const[e,r]of n)t.setAttribute(e,r);return a(t,{$path:"*root",$data:o,$root:o}),delete t.$pow,r.refresh=()=>r.apply(o),r},refresh:()=>{}};return r}return{apply:(t,e)=>i(t).apply(e),bind:i}})();